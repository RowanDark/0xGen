name: 0xgen Provenance Verification

on:
  workflow_run:
    workflows: ['0xgen Release']
    types: [completed]

permissions:
  contents: read

jobs:
  verify:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.workflow_run.repository.full_name }}
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: 0xgen-release-dist
          run-id: ${{ github.event.workflow_run.id }}
          path: dist

      - name: Read release metadata
        id: release
        run: |
          set -euo pipefail
          tag=$(cat dist/RELEASE_TAG)
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"

      - name: Fetch provenance asset
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.release.outputs.tag }}
        run: |
          set -euo pipefail
          gh release download "$TAG" \
            --pattern "0xgen-${TAG}-provenance.intoto.jsonl" \
            --repo "${{ github.event.workflow_run.repository.full_name }}" \
            --dir dist \
            --clobber

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Verify provenance for linux/amd64 archive
        env:
          TAG: ${{ steps.release.outputs.tag }}
        run: |
          set -euo pipefail
          go run ./cmd/0xgenctl verify-build \
            --artifact "dist/0xgenctl_${TAG}_linux_amd64.tar.gz" \
            --attestation "dist/0xgen-${TAG}-provenance.intoto.jsonl" \
            --tag "$TAG" \
            --repo "${{ github.event.workflow_run.repository.full_name }}"
