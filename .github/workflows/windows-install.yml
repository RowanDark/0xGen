name: 0xgen windows-install

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  smoke:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build 0xgenctl snapshot
        shell: pwsh
        run: |
          go build -trimpath -ldflags "-s -w -X main.version=ci-snapshot" -o dist/0xgenctl.exe ./cmd/0xgenctl

      - name: Stage portable archive
        shell: pwsh
        run: |
          $portable = Join-Path dist 'portable'
          New-Item -ItemType Directory -Force -Path $portable | Out-Null
          Copy-Item dist/0xgenctl.exe (Join-Path $portable '0xgenctl.exe')
          Copy-Item README.md (Join-Path $portable 'README.txt')
          Copy-Item LICENSE (Join-Path $portable 'LICENSE.txt')
          Compress-Archive -Path "$portable\*" -DestinationPath dist/0xgenctl_ci_windows_portable.zip -Force

      - name: Install WiX Toolset
        shell: pwsh
        run: choco install wixtoolset --no-progress --yes

      - name: Build MSI installer
        shell: pwsh
        run: |
          $script = (Resolve-Path 'scripts/build_windows_installer.ps1').Path
          $payload = (Resolve-Path 'dist').Path
          & $script -Tag 'v0.0.0-ci' -Arch 'amd64' -PayloadDir $payload -OutputDir $payload

      - name: Smoke test MSI install
        shell: pwsh
        run: |
          $msi = (Resolve-Path 'dist/0xgenctl_v0.0.0-ci_windows_amd64.msi').Path
          Start-Process msiexec.exe -ArgumentList "/i `"$msi`" /qn /norestart" -Wait
          $installedCli = Join-Path $env:ProgramFiles '0xgen\0xgenctl.exe'
          if (-not (Test-Path $installedCli -PathType Leaf)) {
            throw "0xgenctl.exe was not installed"
          }
          & $installedCli --version
          $artifact = (Resolve-Path 'plugins/samples/passive-header-scan/main.go').Path
          $hash = (Get-FileHash $artifact -Algorithm SHA256).Hash
          & $installedCli plugin verify $artifact --hash $hash

      - name: Uninstall MSI
        shell: pwsh
        run: |
          $msi = (Resolve-Path 'dist/0xgenctl_v0.0.0-ci_windows_amd64.msi').Path
          Start-Process msiexec.exe -ArgumentList "/x `"$msi`" /qn /norestart" -Wait
          $installDir = Join-Path $env:ProgramFiles '0xgen'
          if (Test-Path $installDir) {
            throw "Install directory still present after uninstall"
          }

      - name: Smoke test portable build
        shell: pwsh
        run: |
          $extract = Join-Path $env:RUNNER_TEMP '0xgenctl-portable'
          Expand-Archive -Path dist/0xgenctl_ci_windows_portable.zip -DestinationPath $extract -Force
          $portableCli = Join-Path $extract '0xgenctl.exe'
          & $portableCli --version

      - name: Verify plugin subsystem
        shell: pwsh
        run: |
          $portableCli = Join-Path $env:RUNNER_TEMP '0xgenctl-portable' '0xgenctl.exe'
          $artifact = Resolve-Path 'plugins/samples/passive-header-scan/main.go'
          $hash = (Get-FileHash $artifact -Algorithm SHA256).Hash
          & $portableCli plugin verify $artifact --hash $hash
