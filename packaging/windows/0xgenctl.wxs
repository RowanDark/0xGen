<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <?if $(var.WixPlatform) = "x64" ?>
    <?define ProgramFilesFolder = "ProgramFiles64Folder" ?>
  <?elseif $(var.WixPlatform) = "arm64" ?>
    <?define ProgramFilesFolder = "ProgramFiles64Folder" ?>
  <?else ?>
    <?define ProgramFilesFolder = "ProgramFilesFolder" ?>
  <?endif ?>

  <Product Id="*"
           Name="0xgen"
           Language="1033"
           Version="$(var.Version)"
           Manufacturer="0xgen Project"
           UpgradeCode="{CC62A8F1-7D7F-42A7-9C5F-8F71E21C09D6}">
    <Package InstallerVersion="500"
             Compressed="yes"
             InstallScope="perMachine"
             Platform="$(var.WixPlatform)" />
    <MediaTemplate EmbedCab="yes" />
    <MajorUpgrade DowngradeErrorMessage="A newer version of 0xgen is already installed." AllowSameVersionUpgrades="yes" />

    <Feature Id="ZeroXgenCLI" Title="0xgen CLI" Description="Installs the 0xgenctl command-line interface." Level="1" Display="expand">
      <ComponentGroupRef Id="ZeroXgenComponents" />
      <ComponentRef Id="ZeroXgenStartMenuShortcuts" />
    </Feature>
    <Feature Id="ProxyCATrust" Title="Trust Galdr proxy certificate" Description="Installs the 0xgen proxy certificate into the current user's trusted root store." Level="200" AllowAdvertise="no">
      <ComponentRef Id="ZeroXgenProxyTrust" />
    </Feature>
  </Product>

  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="$(var.ProgramFilesFolder)">
        <Directory Id="INSTALLFOLDER" Name="0xgen" />
      </Directory>
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ZeroXgenProgramMenu" Name="0xgen" />
      </Directory>
    </Directory>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="ZeroXgenComponents">
      <Component Id="ZeroXgenExecutable" Guid="{2DFEEA0E-4FD0-4F71-83F2-5C2F11C278F7}" Directory="INSTALLFOLDER" Win64="yes">
        <File Id="ZeroXgenExecutableFile" Source="$(var.PayloadDir)/0xgenctl.exe" KeyPath="yes" />
        <File Id="ZeroXgenLicenseFile" Source="$(var.PayloadDir)/LICENSE.txt" />
        <File Id="ZeroXgenReadmeFile" Source="$(var.PayloadDir)/README.txt" />
        <Environment Id="ZeroXgenPath"
                     Name="PATH"
                     Value="[INSTALLFOLDER]"
                     Action="set"
                     Part="last"
                     System="yes"
                     Permanent="no" />
        <util:FirewallException Id="ZeroXgenProxyFirewall" Name="0xgen proxy" Program="[#ZeroXgenExecutableFile]" Scope="any" Profile="all" />
        <util:FirewallException Id="ZeroXgenReplayFirewall" Name="0xgen replay server" Program="[#ZeroXgenExecutableFile]" Scope="any" Profile="all" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <Fragment>
    <Component Id="ZeroXgenStartMenuShortcuts" Guid="{EC1F5AAF-8570-46B6-9E51-845B32ECA3AB}" Directory="ZeroXgenProgramMenu" Win64="yes">
      <Shortcut Id="ZeroXgenShortcut" Name="0xgen CLI" Description="Open a shell with 0xgenctl on PATH." Target="[#ZeroXgenExecutableFile]" WorkingDirectory="INSTALLFOLDER" />
      <Shortcut Id="ZeroXgenDemoShortcut" Name="0xgen demo" Description="Run the 0xgenctl demo workflow." Target="[#ZeroXgenExecutableFile]" Arguments="demo" WorkingDirectory="INSTALLFOLDER" />
      <RegistryValue Root="HKCU" Key="Software\0xgen" Name="StartMenuShortcuts" Type="integer" Value="1" KeyPath="yes" />
      <RemoveFolder Id="ZeroXgenProgramMenuFolder" Directory="ZeroXgenProgramMenu" On="uninstall" />
    </Component>
  </Fragment>

  <Fragment>
    <Component Id="ZeroXgenProxyTrust" Guid="{B702D0D2-D922-45C7-98AA-A6F9464C7647}" Directory="INSTALLFOLDER" Win64="yes">
      <RegistryValue Root="HKCU" Key="Software\0xgen" Name="ProxyCATrust" Type="integer" Value="1" KeyPath="yes" />
    </Component>
  </Fragment>

  <Fragment>
    <CustomAction Id="InstallProxyCertificate"
                  Directory="INSTALLFOLDER"
                  Execute="deferred"
                  Return="check"
                  Impersonate="yes"
                  ExeCommand="&quot;[#ZeroXgenExecutableFile]&quot; proxy trust --install --quiet" />
    <InstallExecuteSequence>
      <Custom Action="InstallProxyCertificate" After="InstallFiles">NOT REMOVE AND (&ProxyCATrust = 3)</Custom>
    </InstallExecuteSequence>
  </Fragment>
</Wix>
